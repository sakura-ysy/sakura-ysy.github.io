<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="RocksDB源码学习(四): 读(三), SrcMiLeの杂货铺">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>RocksDB源码学习(四): 读(三) | SrcMiLeの杂货铺</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"></head>


    

                <body>
                    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/avatar.jpg" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">SrcMiLeの杂货铺</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>Medias</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>放映室</span>
        </a>
      </li>
      
      <li>
        <a href="/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>破书架</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/avatar.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">SrcMiLeの杂货铺</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			Medias
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>放映室</span>
                  </a>
                </li>
              
                <li>

                  <a href="/books " style="margin-left:75px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:50px" ></i>
			      
		          <span>破书架</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/sakura-ysy" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/sakura-ysy" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

                        



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">RocksDB源码学习(四): 读(三)</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/%E5%AD%98%E5%82%A8/">
                                <span class="chip bg-color">存储</span>
                            </a>
                        
                            <a href="/tags/rocksdb/">
                                <span class="chip bg-color">rocksdb</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%AD%98%E5%82%A8/" class="post-category">
                                存储
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-10-21
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.6k
                </div>
                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>注：本篇博客涉及的代码版本均为<code>v7.7.4</code>。</p>
<p>上两篇博客中我们分析了 RocksDB 如何在内存中查找对应的数据，这一篇我们将会详细分析当内存中未找到记录时，RocksDB 如何在磁盘上查找对应的数据。</p>
<hr>
<p>依旧是从 DBImpl::GetImpl() 开始，当再 memtable 和 immutable memtable 中均没有找到后，会进入如下代码段：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">PERF_TIMER_GUARD</span><span class="token punctuation">(</span>get_from_output_files_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sv<span class="token operator">-></span>current<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>
        read_options<span class="token punctuation">,</span> lkey<span class="token punctuation">,</span> get_impl_options<span class="token punctuation">.</span>value<span class="token punctuation">,</span> get_impl_options<span class="token punctuation">.</span>columns<span class="token punctuation">,</span>
        timestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>merge_context<span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_covering_tombstone_seq<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>pinned_iters_mgr<span class="token punctuation">,</span>
        get_impl_options<span class="token punctuation">.</span>get_value <span class="token operator">?</span> get_impl_options<span class="token punctuation">.</span>value_found <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
        <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
        get_impl_options<span class="token punctuation">.</span>get_value <span class="token operator">?</span> get_impl_options<span class="token punctuation">.</span>callback <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
        get_impl_options<span class="token punctuation">.</span>get_value <span class="token operator">?</span> get_impl_options<span class="token punctuation">.</span>is_blob_index <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
        get_impl_options<span class="token punctuation">.</span>get_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RecordTick</span><span class="token punctuation">(</span>stats_<span class="token punctuation">,</span> MEMTABLE_MISS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>即，会调用 Version::Get() 函数，而这个函数，才真正进入磁盘中开始查找。简单的来说，该函数要先找到可能存在的目标 key 的 sstable，然后再从该 sstable 中查找目标 key，如果没找到，就再找下一个可能存在目标 key 的 sstable，然后继续在其中查找，以此迭代，直到把所有的 level 都找一遍。我们截取它的部分代码，主要分为三个部分，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">Version</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> read_options<span class="token punctuation">,</span> <span class="token keyword">const</span> LookupKey<span class="token operator">&amp;</span> k<span class="token punctuation">,</span>
                  PinnableSlice<span class="token operator">*</span> value<span class="token punctuation">,</span> PinnableWideColumns<span class="token operator">*</span> columns<span class="token punctuation">,</span>
                  std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> timestamp<span class="token punctuation">,</span> Status<span class="token operator">*</span> status<span class="token punctuation">,</span>
                  MergeContext<span class="token operator">*</span> merge_context<span class="token punctuation">,</span>
                  SequenceNumber<span class="token operator">*</span> max_covering_tombstone_seq<span class="token punctuation">,</span>
                  PinnedIteratorsManager<span class="token operator">*</span> pinned_iters_mgr<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> value_found<span class="token punctuation">,</span>
                  <span class="token keyword">bool</span><span class="token operator">*</span> key_exists<span class="token punctuation">,</span> SequenceNumber<span class="token operator">*</span> seq<span class="token punctuation">,</span> ReadCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span>
                  <span class="token keyword">bool</span><span class="token operator">*</span> is_blob<span class="token punctuation">,</span> <span class="token keyword">bool</span> do_merge<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  GetContext <span class="token function">get_context</span><span class="token punctuation">(</span>
      <span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> merge_operator_<span class="token punctuation">,</span> info_log_<span class="token punctuation">,</span> db_statistics_<span class="token punctuation">,</span>
      status<span class="token operator">-></span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> GetContext<span class="token double-colon punctuation">::</span>kNotFound <span class="token operator">:</span> GetContext<span class="token double-colon punctuation">::</span>kMerge<span class="token punctuation">,</span> user_key<span class="token punctuation">,</span>
      do_merge <span class="token operator">?</span> value <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> do_merge <span class="token operator">?</span> columns <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span>
      do_merge <span class="token operator">?</span> timestamp <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> value_found<span class="token punctuation">,</span> merge_context<span class="token punctuation">,</span> do_merge<span class="token punctuation">,</span>
      max_covering_tombstone_seq<span class="token punctuation">,</span> clock_<span class="token punctuation">,</span> seq<span class="token punctuation">,</span>
      merge_operator_ <span class="token operator">?</span> pinned_iters_mgr <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> callback<span class="token punctuation">,</span> is_blob_to_use<span class="token punctuation">,</span>
      tracing_get_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>blob_fetcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
  FilePicker <span class="token function">fp</span><span class="token punctuation">(</span>user_key<span class="token punctuation">,</span> ikey<span class="token punctuation">,</span> <span class="token operator">&amp;</span>storage_info_<span class="token punctuation">.</span>level_files_brief_<span class="token punctuation">,</span>
                storage_info_<span class="token punctuation">.</span>num_non_empty_levels_<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>storage_info_<span class="token punctuation">.</span>file_indexer_<span class="token punctuation">,</span> <span class="token function">user_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">internal_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  FdWithKeyRange<span class="token operator">*</span> f <span class="token operator">=</span> fp<span class="token punctuation">.</span><span class="token function">GetNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token keyword">while</span> <span class="token punctuation">(</span>f <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>status <span class="token operator">=</span> table_cache_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>
        read_options<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">internal_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>f<span class="token operator">-></span>file_metadata<span class="token punctuation">,</span> ikey<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>get_context<span class="token punctuation">,</span> mutable_cf_options_<span class="token punctuation">.</span>prefix_extractor<span class="token punctuation">,</span>
        cfd_<span class="token operator">-></span><span class="token function">internal_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetFileReadHist</span><span class="token punctuation">(</span>fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">IsFilterSkipped</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        fp<span class="token punctuation">.</span><span class="token function">IsHitFileLastInLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_file_size_for_l0_meta_pin_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>get_context<span class="token punctuation">.</span><span class="token function">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kFound<span class="token operator">:</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">&#125;</span>
    f <span class="token operator">=</span> fp<span class="token punctuation">.</span><span class="token function">GetNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>四个部分依次如下：</p>
<ul>
<li>用 get_context 来维护查找过程中的上下文，类似与在 memtable 中查找时的 saver。</li>
<li>创建一个文件选择器 FilePicker，名为 fp。</li>
<li>通过 fp.GetNextFile() 得到可能存在目标 key 的 sstable。</li>
<li>通过 table_cache_-&gt;Get() 在上述 sstable 中查找目标 key，如果没找到就重新执行步骤 3 来迭代。</li>
</ul>
<h2 id="GetContext"><a href="#GetContext" class="headerlink" title="GetContext"></a>GetContext</h2><p>首先看查找前的初始化，创建一个变量 get_context，其类型未类 GetContext，该类用来保存查询过程中的一些上下文，比如目标 key、查询状态、时间戳等等，其作用类似于在 memtable 中辅助查找的结构体 Saver。构造函数如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token class-name">GetContext</span><span class="token double-colon punctuation">::</span><span class="token function">GetContext</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Comparator<span class="token operator">*</span> ucmp<span class="token punctuation">,</span> <span class="token keyword">const</span> MergeOperator<span class="token operator">*</span> merge_operator<span class="token punctuation">,</span> Logger<span class="token operator">*</span> logger<span class="token punctuation">,</span>
    Statistics<span class="token operator">*</span> statistics<span class="token punctuation">,</span> GetState init_state<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> user_key<span class="token punctuation">,</span>
    PinnableSlice<span class="token operator">*</span> pinnable_val<span class="token punctuation">,</span> PinnableWideColumns<span class="token operator">*</span> columns<span class="token punctuation">,</span>
    std<span class="token double-colon punctuation">::</span>string<span class="token operator">*</span> timestamp<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> value_found<span class="token punctuation">,</span> MergeContext<span class="token operator">*</span> merge_context<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> do_merge<span class="token punctuation">,</span> SequenceNumber<span class="token operator">*</span> _max_covering_tombstone_seq<span class="token punctuation">,</span>
    SystemClock<span class="token operator">*</span> clock<span class="token punctuation">,</span> SequenceNumber<span class="token operator">*</span> seq<span class="token punctuation">,</span>
    PinnedIteratorsManager<span class="token operator">*</span> _pinned_iters_mgr<span class="token punctuation">,</span> ReadCallback<span class="token operator">*</span> callback<span class="token punctuation">,</span>
    <span class="token keyword">bool</span><span class="token operator">*</span> is_blob_index<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> tracing_get_id<span class="token punctuation">,</span> BlobFetcher<span class="token operator">*</span> blob_fetcher<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">ucmp_</span><span class="token punctuation">(</span>ucmp<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">merge_operator_</span><span class="token punctuation">(</span>merge_operator<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">logger_</span><span class="token punctuation">(</span>logger<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">statistics_</span><span class="token punctuation">(</span>statistics<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">state_</span><span class="token punctuation">(</span>init_state<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">user_key_</span><span class="token punctuation">(</span>user_key<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">pinnable_val_</span><span class="token punctuation">(</span>pinnable_val<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">columns_</span><span class="token punctuation">(</span>columns<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">timestamp_</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">value_found_</span><span class="token punctuation">(</span>value_found<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">merge_context_</span><span class="token punctuation">(</span>merge_context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">max_covering_tombstone_seq_</span><span class="token punctuation">(</span>_max_covering_tombstone_seq<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">clock_</span><span class="token punctuation">(</span>clock<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">seq_</span><span class="token punctuation">(</span>seq<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">replay_log_</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">pinned_iters_mgr_</span><span class="token punctuation">(</span>_pinned_iters_mgr<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">callback_</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">do_merge_</span><span class="token punctuation">(</span>do_merge<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">is_blob_index_</span><span class="token punctuation">(</span>is_blob_index<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">tracing_get_id_</span><span class="token punctuation">(</span>tracing_get_id<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">blob_fetcher_</span><span class="token punctuation">(</span>blob_fetcher<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>seq_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>seq_ <span class="token operator">=</span> kMaxSequenceNumber<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  sample_ <span class="token operator">=</span> <span class="token function">should_sample_file_read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>需要留意一下，当 Version::Get() 构造 GetContext 时，第 7 个参数 pinnable_val（PinnableSlice* ）的值取决于 do_merge，如果 do_merge 为 true，则传入 value（PinnableSlice*），反之则传入 nullptr。</p>
<h2 id="FilePicker"><a href="#FilePicker" class="headerlink" title="FilePicker"></a>FilePicker</h2><p>接下来我们看一下辅助类 FilePicker，类如其名，作用就是通过传入的 user_key （LookupKey 中的）来获取到可能位于的 sstable 里。该类的一些私有字段如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">FilePicker</span> <span class="token punctuation">&#123;</span>
 <span class="token comment">// ...</span>
 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_levels_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> curr_level_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> returned_file_level_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> hit_file_level_<span class="token punctuation">;</span>
  <span class="token keyword">int32_t</span> search_left_bound_<span class="token punctuation">;</span>
  <span class="token keyword">int32_t</span> search_right_bound_<span class="token punctuation">;</span>
  autovector<span class="token operator">&lt;</span>LevelFilesBrief<span class="token operator">></span><span class="token operator">*</span> level_files_brief_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> search_ended_<span class="token punctuation">;</span>
  <span class="token keyword">bool</span> is_hit_file_last_in_level_<span class="token punctuation">;</span>
  LevelFilesBrief<span class="token operator">*</span> curr_file_level_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> curr_index_in_curr_level_<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> start_index_in_curr_level_<span class="token punctuation">;</span>
  Slice user_key_<span class="token punctuation">;</span>
  Slice ikey_<span class="token punctuation">;</span>
  FileIndexer<span class="token operator">*</span> file_indexer_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> Comparator<span class="token operator">*</span> user_comparator_<span class="token punctuation">;</span>
  <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">*</span> internal_comparator_<span class="token punctuation">;</span>
 <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>先简单的介绍一下各字段的含义：</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>num_levels_</td>
<td>磁盘中一共有多少层 level</td>
</tr>
<tr>
<td>curr_level_</td>
<td>当前所在的 level</td>
</tr>
<tr>
<td>returned_file_level_</td>
<td>返回的 sstable 所在的 level</td>
</tr>
<tr>
<td>hit_file_level_</td>
<td>命中的 sstable 所在的 level</td>
</tr>
<tr>
<td>search_left_bound_</td>
<td>下一层查找的左边界 sstable 下标</td>
</tr>
<tr>
<td>search_right_bound_</td>
<td>下一层查找的右边界 sstable 下标</td>
</tr>
<tr>
<td>level_files_brief_</td>
<td>所有 level 的 LevelFilesBrief 组成的一个 vector</td>
</tr>
<tr>
<td>search_ended_</td>
<td>查找是否结束</td>
</tr>
<tr>
<td>is_hit_file_last_in_level_</td>
<td>命中的 sstable 是否为当前 level 中的最后一个</td>
</tr>
<tr>
<td>curr_file_level_</td>
<td>LevelFilesBrief 类型，为一个 level 中的所有 sstable 组成的数组的头节点</td>
</tr>
<tr>
<td>curr_index_in_curr_level_</td>
<td>当前 sstable 位于当前 level 的下标</td>
</tr>
<tr>
<td>start_index_in_curr_level_</td>
<td>当前 level 的查找起点 sstable 的下标</td>
</tr>
<tr>
<td>user_key_</td>
<td>目标 user_key（实际就是 ikey_ 中的 user_key）</td>
</tr>
<tr>
<td>ikey_</td>
<td>LookupKey</td>
</tr>
</tbody></table>
<p>这里，我们重点关注三个字段：search_left_bound_ 、search_right_bound_ 、level_files_brief_，它们三个均和接下来要介绍的重点函数 GetNextFile() 密不可分。在介绍开始之前，我们先回顾一下 RocksDB 在磁盘中迭代查找 sstable 的逻辑：</p>
<p>level0 是可重叠的，因此迭代时，要把整个 level0 遍历一遍。而在非 level0，每层只需定位到一个 sstable 即可，如果该层查找失败，进入下一层，而这 “定位” 就是问题的关键。当要进入下一个 level 开始查找时，RocksDB 不会把遍历该 level 来查 sstable，而是通过二分查找的方式所有 sstable 的范围。</p>
<p>为了加速二分查找的速度，每次更新 sstable 的时候，RocksDB 都会调用 FileIndexer::UpdateIndex() 来更新一个结构，名为 FileIndexer，它主要是用来保存每一个 level 和 level+1 的 key 范围的关联信息，这样当我们在 level查找的时候，如果没有查找到信息，那么我们将会迅速得到下一个 level 需要查找的 sstable 范围。至于怎么更新的，我们先不管。每一个 key 来进行比较只会有三种情况：</p>
<ul>
<li>小于当前 sstable 的 smallest。</li>
<li>大于当前 sstable 的 largest。</li>
<li>处于这个范围。</li>
</ul>
<p>FileIndexer 维护了如下四个字段：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Point to a left most file in a lower level that may contain a key,</span>
<span class="token comment">// which compares greater than smallest of a FileMetaData (upper level)</span>
<span class="token keyword">int32_t</span> smallest_lb<span class="token punctuation">;</span>
<span class="token comment">// Point to a left most file in a lower level that may contain a key,</span>
<span class="token comment">// which compares greater than largest of a FileMetaData (upper level)</span>
<span class="token keyword">int32_t</span> largest_lb<span class="token punctuation">;</span>
<span class="token comment">// Point to a right most file in a lower level that may contain a key,</span>
<span class="token comment">// which compares smaller than smallest of a FileMetaData (upper level)</span>
<span class="token keyword">int32_t</span> smallest_rb<span class="token punctuation">;</span>
<span class="token comment">// Point to a right most file in a lower level that may contain a key,</span>
<span class="token comment">// which compares smaller than largest of a FileMetaData (upper level)</span>
<span class="token keyword">int32_t</span> largest_rb<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>官方还给了例子来帮助理解，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example:</span>
<span class="token comment">//    level 1:              [50 - 60]</span>
<span class="token comment">//    level 2:        [1 - 40], [45 - 55], [58 - 80]</span>
<span class="token comment">// A key 35, compared to be less than 50, 3rd file on level 2 can be</span>
<span class="token comment">// skipped according to rule (1). LB = 0, RB = 1.</span>
<span class="token comment">// A key 53, sits in the middle 50 and 60. 1st file on level 2 can be</span>
<span class="token comment">// skipped according to rule (2)-a, but the 3rd file cannot be skipped</span>
<span class="token comment">// because 60 is greater than 58. LB = 1, RB = 2.</span>
<span class="token comment">// A key 70, compared to be larger than 60. 1st and 2nd file can be skipped</span>
<span class="token comment">// according to rule (3). LB = 2, RB = 2.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>对于 level1 的 [50, 60] 而言，其 smallest 为 50，largest 为 60。smallest_lb 指下一级中恰好包含比 smallest 大的 sstable，故为 1，即 [45, 55]。smallest_rb 指下一级中恰好包含比 smallest 小的 sstable，故为 1，即 [45, 55]。largest_lb 指下一级中恰好包含比 largest 大的 sstable，故为 2，即 [58, 80]。largest_rb 指下一级中恰好包含比 largest 小的 sstable，故为 2，即 [58, 80]。</p>
<p>在 level1 中查找 key 35，没有找到，且在 sstable 左边，因此需要跳到 level2 中的 0 ~ smallest_lb 中去找，即sstable0 和 sstable 1。key 53 没有找到，且在 sstable 内部，因此需要跳到 level2 的重合区间去找，故范围为 smallest_lb ~ largest_rb，即 sstable1 和 sstable 2。 key35 没找到，且在 sstable 右边，因此需要跳到 level2 中的 largest_lb ~ 右边界 中去找，即 sstable2 本身。</p>
<p>明白了这个 level 之间的关系之后，再来看 GetNextFile() 的实现。</p>
<h3 id="GetNextFile"><a href="#GetNextFile" class="headerlink" title="GetNextFile"></a>GetNextFile</h3><p>首先要明确 GetNextFile 的作用，它是一个迭代函数，每调用一次，都会返回下一个可能存在目标 key 的 sstable。用图示表明如下：</p>
<img src="https://s1.ax1x.com/2022/10/24/x22a6J.png" alt="sstable命中示例" style="zoom: 50%;" />

<p>这也就是为什么，在 Version::Get() 中首先通过 GetNextFile() 来获取到一个可能 sstable，然后在其中查找，如果没找到就再调用一次 GetNextFile() 获取下一个可能 sstable，以此循环，直到找到目标 key 或全部 level 都找完。现在来看下该函数的具体实现，其完整源码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">FdWithKeyRange<span class="token operator">*</span> <span class="token function">GetNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>search_ended_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// Loops over different levels.</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>curr_index_in_curr_level_ <span class="token operator">&lt;</span> curr_file_level_<span class="token operator">-></span>num_files<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Loops over all files in current level.</span>
        FdWithKeyRange<span class="token operator">*</span> f <span class="token operator">=</span> <span class="token operator">&amp;</span>curr_file_level_<span class="token operator">-></span>files<span class="token punctuation">[</span>curr_index_in_curr_level_<span class="token punctuation">]</span><span class="token punctuation">;</span>
        hit_file_level_ <span class="token operator">=</span> curr_level_<span class="token punctuation">;</span>
        is_hit_file_last_in_level_ <span class="token operator">=</span>
            curr_index_in_curr_level_ <span class="token operator">==</span> curr_file_level_<span class="token operator">-></span>num_files <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> cmp_largest <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token comment">// Do key range filtering of files or/and fractional cascading if:</span>
        <span class="token comment">// (1) not all the files are in level 0, or</span>
        <span class="token comment">// (2) there are more than 3 current level files</span>
        <span class="token comment">// If there are only 3 or less current level files in the system, we skip</span>
        <span class="token comment">// the key range filtering. In this case, more likely, the system is</span>
        <span class="token comment">// highly tuned to minimize number of tables queried by each query,</span>
        <span class="token comment">// so it is unlikely that key range filtering is more efficient than</span>
        <span class="token comment">// querying the files.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num_levels_ <span class="token operator">></span> <span class="token number">1</span> <span class="token operator">||</span> curr_file_level_<span class="token operator">-></span>num_files <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// Check if key is within a file's range. If search left bound and</span>
          <span class="token comment">// right bound point to the same find, we are sure key falls in</span>
          <span class="token comment">// range.</span>
          <span class="token function">assert</span><span class="token punctuation">(</span>curr_level_ <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span>
                 curr_index_in_curr_level_ <span class="token operator">==</span> start_index_in_curr_level_ <span class="token operator">||</span>
                 user_comparator_<span class="token operator">-></span><span class="token function">CompareWithoutTimestamp</span><span class="token punctuation">(</span>
                     user_key_<span class="token punctuation">,</span> <span class="token function">ExtractUserKey</span><span class="token punctuation">(</span>f<span class="token operator">-></span>smallest_key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">int</span> cmp_smallest <span class="token operator">=</span> user_comparator_<span class="token operator">-></span><span class="token function">CompareWithoutTimestamp</span><span class="token punctuation">(</span>
              user_key_<span class="token punctuation">,</span> <span class="token function">ExtractUserKey</span><span class="token punctuation">(</span>f<span class="token operator">-></span>smallest_key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            cmp_largest <span class="token operator">=</span> user_comparator_<span class="token operator">-></span><span class="token function">CompareWithoutTimestamp</span><span class="token punctuation">(</span>
                user_key_<span class="token punctuation">,</span> <span class="token function">ExtractUserKey</span><span class="token punctuation">(</span>f<span class="token operator">-></span>largest_key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>

          <span class="token comment">// Setup file search bound for the next level based on the</span>
          <span class="token comment">// comparison results</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            file_indexer_<span class="token operator">-></span><span class="token function">GetNextLevelIndex</span><span class="token punctuation">(</span>curr_level_<span class="token punctuation">,</span>
                                            curr_index_in_curr_level_<span class="token punctuation">,</span>
                                            cmp_smallest<span class="token punctuation">,</span> cmp_largest<span class="token punctuation">,</span>
                                            <span class="token operator">&amp;</span>search_left_bound_<span class="token punctuation">,</span>
                                            <span class="token operator">&amp;</span>search_right_bound_<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
          <span class="token comment">// Key falls out of current file's range</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> cmp_largest <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
              <span class="token operator">++</span>curr_index_in_curr_level_<span class="token punctuation">;</span>
              <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
              <span class="token comment">// Search next level.</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>

        returned_file_level_ <span class="token operator">=</span> curr_level_<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cmp_largest <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token comment">// No more files to search in this level.</span>
          search_ended_ <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">PrepareNextLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
          <span class="token operator">++</span>curr_index_in_curr_level_<span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
        <span class="token keyword">return</span> f<span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token comment">// Start searching next level.</span>
      search_ended_ <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">PrepareNextLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Search ended.</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>我们只考虑层数大于 1 的情况，这最普遍。首先，该函数通过 curr_index_in_curr_level_ 来获取当前查找到的 sstable，然后比较目标 key 和 smallest 以及 largest 的大小，结果存在 cmp_smallest 与 cmp_largest 中。因为在 level0 中有重叠，所以需要遍历完整个 level0，只有在 level1 及以上才会启用 FileIndexer 关系。先考虑 level0，跳过 curr_level_ &gt; 0 的判断。如果目标 key 不在 sstable 内，那就 ++curr_index_in_curr_level_ ，然后 continue，此时会进入 level0 的下一个 sstable 中重复，如果在，那么依然  ++ curr_index_in_curr_level_ ，然后返回这个 sstable，在下一次调用 GetNextFile() 的时候会进入下一个 sstable 中重复。</p>
<p>如果在非 level0，那么就需要先通过 file_indexer_-&gt;GetNextLevelIndex() 来定位到 level+1 中的 sstable。如果目标 key 不在当前 sstable，那么直接 break，通过 PrepareNextLevel() 来进入 level+1 中，查找点就是刚刚定位的 sstable。这里有两个注意点：</p>
<ul>
<li>file_indexer_-&gt;GetNextLevelIndex() 就是通过 FileIndexer 来进行的。</li>
<li>非 level0 中，判断失败立刻 break，进入下一层。说明每一层只检查<strong>一个</strong> sstable，而不是在某一个范围内遍历，这个很重要！</li>
</ul>
<h4 id="GetNextLevelIndex"><a href="#GetNextLevelIndex" class="headerlink" title="GetNextLevelIndex"></a>GetNextLevelIndex</h4><p>分点来看，首先是 GetNextLevelIndex()，其完整源码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">FileIndexer</span><span class="token double-colon punctuation">::</span><span class="token function">GetNextLevelIndex</span><span class="token punctuation">(</span><span class="token keyword">const</span> size_t level<span class="token punctuation">,</span> <span class="token keyword">const</span> size_t file_index<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> <span class="token keyword">int</span> cmp_smallest<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> <span class="token keyword">int</span> cmp_largest<span class="token punctuation">,</span> <span class="token keyword">int32_t</span><span class="token operator">*</span> left_bound<span class="token punctuation">,</span>
                                    <span class="token keyword">int32_t</span><span class="token operator">*</span> right_bound<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>level <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Last level, no hint</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">==</span> num_levels_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span>level <span class="token operator">&lt;</span> num_levels_ <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>file_index<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> level_rb_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> IndexUnit<span class="token operator">*</span> index_units <span class="token operator">=</span> next_level_index_<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">.</span>index_units<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> index <span class="token operator">=</span> index_units<span class="token punctuation">[</span>file_index<span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> <span class="token punctuation">(</span>level <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> file_index <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span>
                      <span class="token operator">?</span> index_units<span class="token punctuation">[</span>file_index <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>largest_lb
                      <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>smallest_rb<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>smallest_lb<span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>smallest_rb<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cmp_largest <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>smallest_lb<span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>largest_rb<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_largest <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>largest_lb<span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>largest_rb<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_largest <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token operator">*</span>left_bound <span class="token operator">=</span> index<span class="token punctuation">.</span>largest_lb<span class="token punctuation">;</span>
    <span class="token operator">*</span>right_bound <span class="token operator">=</span> level_rb_<span class="token punctuation">[</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span>left_bound <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span>left_bound <span class="token operator">&lt;=</span> <span class="token operator">*</span>right_bound <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token operator">*</span>right_bound <span class="token operator">&lt;=</span> level_rb_<span class="token punctuation">[</span>level <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>逻辑很简单，就是结合比较结果与 FileIndexer 中的四个字段，计算出 search_left_bound_ 与 search_right_bound_，即下一层的查找范围。</p>
<h4 id="PrepareNextLevel"><a href="#PrepareNextLevel" class="headerlink" title="PrepareNextLevel"></a>PrepareNextLevel</h4><p>这样一来，第二个注意点就出问题了。search_left_bound_  和 search_right_bound_ 明明代表的是一个范围，比如前文示例中 key 35 的下一层查找范围为 [0, 1]，但为什么在 GetNextFile() 每一层只查找一个 sstable 呢？这个问题困扰了我大概一天，甚至怀疑过是不是源码写错了。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Key falls out of current file's range</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>cmp_smallest <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> cmp_largest <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token operator">++</span>curr_index_in_curr_level_<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Search next level.</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>实际上，RocksDB 对下一个 level 中 sstable 的定位，就是直接定到其中一个。只不过它分了两步。第一步通过 FileIndexer 来确定 search_left_bound_  和 search_right_bound_ ，第二步就是在这个范围内具体定到某一个 sstable 中。而第二步的实现，就是在 PrepareNextLevel() 中，我们看一下它的源码：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">bool</span> <span class="token function">PrepareNextLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    curr_level_<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">&lt;</span> num_levels_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        curr_file_level_ <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token operator">*</span>level_files_brief_<span class="token punctuation">)</span><span class="token punctuation">[</span>curr_level_<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_file_level_<span class="token operator">-></span>num_files <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// When current level is empty, the search bound generated from upper</span>
            <span class="token comment">// level must be [0, -1] or [0, FileIndexer::kLevelMaxIndex] if it is</span>
            <span class="token comment">// also empty.</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>search_left_bound_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>search_right_bound_ <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
                   search_right_bound_ <span class="token operator">==</span> FileIndexer<span class="token double-colon punctuation">::</span>kLevelMaxIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// Since current level is empty, it will need to search all files in</span>
            <span class="token comment">// the next level</span>
            search_left_bound_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            search_right_bound_ <span class="token operator">=</span> FileIndexer<span class="token double-colon punctuation">::</span>kLevelMaxIndex<span class="token punctuation">;</span>
            curr_level_<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token comment">// Some files may overlap each other. We find</span>
        <span class="token comment">// all files that overlap user_key and process them in order from</span>
        <span class="token comment">// newest to oldest. In the context of merge-operator, this can occur at</span>
        <span class="token comment">// any level. Otherwise, it only occurs at Level-0 (since Put/Deletes</span>
        <span class="token comment">// are always compacted into a single entry).</span>
        <span class="token keyword">int32_t</span> start_index<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>curr_level_ <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// On Level-0, we read through all files to check for overlap.</span>
            start_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">// On Level-n (n>=1), files are sorted. Binary search to find the</span>
            <span class="token comment">// earliest file whose largest key >= ikey. Search left bound and</span>
            <span class="token comment">// right bound are used to narrow the range.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>search_left_bound_ <span class="token operator">&lt;=</span> search_right_bound_<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>search_right_bound_ <span class="token operator">==</span> FileIndexer<span class="token double-colon punctuation">::</span>kLevelMaxIndex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    search_right_bound_ <span class="token operator">=</span>
                        <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>curr_file_level_<span class="token operator">-></span>num_files<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
                <span class="token comment">// `search_right_bound_` is an inclusive upper-bound, but since it was</span>
                <span class="token comment">// determined based on user key, it is still possible the lookup key</span>
                <span class="token comment">// falls to the right of `search_right_bound_`'s corresponding file.</span>
                <span class="token comment">// So, pass a limit one higher, which allows us to detect this case.</span>
                start_index <span class="token operator">=</span>
                    <span class="token function">FindFileInRange</span><span class="token punctuation">(</span><span class="token operator">*</span>internal_comparator_<span class="token punctuation">,</span> <span class="token operator">*</span>curr_file_level_<span class="token punctuation">,</span> ikey_<span class="token punctuation">,</span>
                                    <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>search_left_bound_<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>search_right_bound_<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>start_index <span class="token operator">==</span> search_right_bound_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    <span class="token comment">// `ikey_` comes after `search_right_bound_`. The lookup key does</span>
                    <span class="token comment">// not exist on this level, so let's skip this level and do a full</span>
                    <span class="token comment">// binary search on the next level.</span>
                    search_left_bound_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    search_right_bound_ <span class="token operator">=</span> FileIndexer<span class="token double-colon punctuation">::</span>kLevelMaxIndex<span class="token punctuation">;</span>
                    curr_level_<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// search_left_bound > search_right_bound, key does not exist in</span>
                <span class="token comment">// this level. Since no comparison is done in this level, it will</span>
                <span class="token comment">// need to search all files in the next level.</span>
                search_left_bound_ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                search_right_bound_ <span class="token operator">=</span> FileIndexer<span class="token double-colon punctuation">::</span>kLevelMaxIndex<span class="token punctuation">;</span>
                curr_level_<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
        start_index_in_curr_level_ <span class="token operator">=</span> start_index<span class="token punctuation">;</span>
        curr_index_in_curr_level_ <span class="token operator">=</span> start_index<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// curr_level_ = num_levels_. So, no more levels to search.</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>该函数作用很明确，首先是 curr_level_ ++，指进入了下一层，其次就是通过 search_left_bound_  和 search_right_bound_  来确定 start_index，这个 start_index 就是下一层中定位的 sstable 下标。官方对其的解释如下：</p>
<blockquote>
<p>On Level-n (n&gt;=1), files are sorted. Binary search to find the earliest file whose largest key &gt;= ikey. Search left bound and right bound are used to narrow the range.</p>
</blockquote>
<p>意思是，startIndex 就是最早的满足 largest &gt;= 目标 key 的 sstable 下标，其由如下代码块确定：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">start_index <span class="token operator">=</span>
    <span class="token function">FindFileInRange</span><span class="token punctuation">(</span><span class="token operator">*</span>internal_comparator_<span class="token punctuation">,</span> <span class="token operator">*</span>curr_file_level_<span class="token punctuation">,</span> ikey_<span class="token punctuation">,</span>
                    <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>search_left_bound_<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint32_t</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>search_right_bound_<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>进入该函数看一看，源码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Find File in LevelFilesBrief data structure</span>
<span class="token comment">// Within an index range defined by left and right</span>
<span class="token keyword">int</span> <span class="token function">FindFileInRange</span><span class="token punctuation">(</span><span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> icmp<span class="token punctuation">,</span>
    <span class="token keyword">const</span> LevelFilesBrief<span class="token operator">&amp;</span> file_level<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> key<span class="token punctuation">,</span>
    <span class="token keyword">uint32_t</span> left<span class="token punctuation">,</span>
    <span class="token keyword">uint32_t</span> right<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">auto</span> cmp <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> FdWithKeyRange<span class="token operator">&amp;</span> f<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">bool</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">return</span> icmp<span class="token punctuation">.</span><span class="token class-name">InternalKeyComparator</span><span class="token double-colon punctuation">::</span><span class="token function">Compare</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>largest_key<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">auto</span> <span class="token operator">&amp;</span>b <span class="token operator">=</span> file_level<span class="token punctuation">.</span>files<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">lower_bound</span><span class="token punctuation">(</span>b <span class="token operator">+</span> left<span class="token punctuation">,</span>
                                           b <span class="token operator">+</span> right<span class="token punctuation">,</span> key<span class="token punctuation">,</span> cmp<span class="token punctuation">)</span> <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>这就很明确了，该函数其实就是个 lower_bound，核心是比较器。可以看出，比较器会将 sstable 中的 largest 与目标 key 来进行比较，小于在返回 true。故该函数就是返回最早的满足 largest &gt;= 目标 key 的 sstable 下标。仍然拿官方的列子来看：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Example:</span>
<span class="token comment">//    level 1:              [50 - 60]</span>
<span class="token comment">//    level 2:        [1 - 40], [45 - 55], [58 - 80]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>level1 查找完 key 35 时，level2 对应范围为 [0，1]，但显然 35 只可能落在 [1 - 40] 中，因为它是最早的满足 largeset &gt;=  35 的 sstable，所以 start_index 为 0，[45 - 55] 就没必要去搜索了 。level1 查找完 key 53 时，level2 对应范围为 [1，2]，但显然 53 只可能落在 [45 - 55] 中，理由同上，故 stat_index 为 1。</p>
<p>至此就是解释了第二个注意点的问题了，因为 PrepareNextLevel() 会直接定位到 level+1 中一个具体的 sstable 上，而不是一个范围，所以每一层只检查一个 sstable 就行。</p>
<h2 id="TableCache"><a href="#TableCache" class="headerlink" title="TableCache"></a>TableCache</h2><p>当 FilePicker 找到一个 sstable 后，RocksDB 会调用 TableCache::Get() 来在这个 sstable 中查找，并把一些信息保存在 get_context 中·</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token operator">*</span>status <span class="token operator">=</span> table_cache_<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>
    read_options<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token function">internal_comparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span>f<span class="token operator">-></span>file_metadata<span class="token punctuation">,</span> ikey<span class="token punctuation">,</span>
    <span class="token operator">&amp;</span>get_context<span class="token punctuation">,</span> mutable_cf_options_<span class="token punctuation">.</span>prefix_extractor<span class="token punctuation">,</span>
    cfd_<span class="token operator">-></span><span class="token function">internal_stats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">GetFileReadHist</span><span class="token punctuation">(</span>fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">IsFilterSkipped</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span></span></span><span class="token punctuation">(</span>fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    fp<span class="token punctuation">.</span><span class="token function">IsHitFileLastInLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    fp<span class="token punctuation">.</span><span class="token function">GetHitFileLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> max_file_size_for_l0_meta_pin_<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>当返回后，通过 get_context 来判断返回的结果是否符合预期。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">switch</span> <span class="token punctuation">(</span>get_context<span class="token punctuation">.</span><span class="token function">State</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kNotFound<span class="token operator">:</span>
    <span class="token comment">// Keep searching in other files</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kMerge<span class="token operator">:</span>
    <span class="token comment">// TODO: update per-level perfcontext user_key_return_count for kMerge</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kFound<span class="token operator">:</span>
    <span class="token comment">// ... 主要在这</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kDeleted<span class="token operator">:</span>
    <span class="token operator">*</span>status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">NotFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kCorrupt<span class="token operator">:</span>
    <span class="token operator">*</span>status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">Corruption</span><span class="token punctuation">(</span><span class="token string">"corrupted key for "</span><span class="token punctuation">,</span> user_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kUnexpectedBlobIndex<span class="token operator">:</span>
    <span class="token function">ROCKS_LOG_ERROR</span><span class="token punctuation">(</span>info_log_<span class="token punctuation">,</span> <span class="token string">"Encounter unexpected blob index."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">NotSupported</span><span class="token punctuation">(</span>
        <span class="token string">"Encounter unexpected blob index. Please open DB with "</span>
        <span class="token string">"ROCKSDB_NAMESPACE::blob_db::BlobDB instead."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> GetContext<span class="token double-colon punctuation">::</span>kUnexpectedWideColumnEntity<span class="token operator">:</span>
    <span class="token operator">*</span>status <span class="token operator">=</span>
        <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">NotSupported</span><span class="token punctuation">(</span><span class="token string">"Encountered unexpected wide-column entity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果不符合预期，那么会重新调用 GetNextLevelIndex() 重复上述过程。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">f <span class="token operator">=</span> fp<span class="token punctuation">.</span><span class="token function">GetNextFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<p>接下来，我们进入最核心的 TableCache::Get()，该函数的主要工作为两点：</p>
<ul>
<li>cache 相关的信息，分为两个 cache：<ul>
<li>row_cache，用来 cache &lt;key, vlaue&gt;</li>
<li>table_cache，用来 cache &lt;key，sstable&gt;</li>
</ul>
</li>
<li>从 sstable 中查找目标 key。</li>
</ul>
<p>我们源码中主要的部分，如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Status <span class="token class-name">TableCache</span><span class="token double-colon punctuation">::</span><span class="token function">Get</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
    <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> internal_comparator<span class="token punctuation">,</span>
    <span class="token keyword">const</span> FileMetaData<span class="token operator">&amp;</span> file_meta<span class="token punctuation">,</span> <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> k<span class="token punctuation">,</span> GetContext<span class="token operator">*</span> get_context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SliceTransform<span class="token operator">></span><span class="token operator">&amp;</span> prefix_extractor<span class="token punctuation">,</span>
    HistogramImpl<span class="token operator">*</span> file_read_hist<span class="token punctuation">,</span> <span class="token keyword">bool</span> skip_filters<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span>
    size_t max_file_size_for_l0_meta_pin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
  <span class="token comment">// ...</span>
  <span class="token comment">// Check row cache if enabled. Since row cache does not currently store</span>
  <span class="token comment">// sequence numbers, we cannot use it if we need to fetch the sequence.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ioptions_<span class="token punctuation">.</span>row_cache <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>get_context<span class="token operator">-></span><span class="token function">NeedToReadSequence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">auto</span> user_key <span class="token operator">=</span> <span class="token function">ExtractUserKey</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CreateRowCacheKeyPrefix</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> fd<span class="token punctuation">,</span> k<span class="token punctuation">,</span> get_context<span class="token punctuation">,</span> row_cache_key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    done <span class="token operator">=</span> <span class="token function">GetFromRowCache</span><span class="token punctuation">(</span>user_key<span class="token punctuation">,</span> row_cache_key<span class="token punctuation">,</span> row_cache_key<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           get_context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      row_cache_entry <span class="token operator">=</span> <span class="token operator">&amp;</span>row_cache_entry_buffer<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// ...</span>
  Status s<span class="token punctuation">;</span>
  TableReader<span class="token operator">*</span> t <span class="token operator">=</span> fd<span class="token punctuation">.</span>table_reader<span class="token punctuation">;</span>
  Cache<span class="token double-colon punctuation">::</span>Handle<span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      s <span class="token operator">=</span> <span class="token function">FindTable</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> file_options_<span class="token punctuation">,</span> internal_comparator<span class="token punctuation">,</span> file_meta<span class="token punctuation">,</span>
                    <span class="token operator">&amp;</span>handle<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">,</span>
                    options<span class="token punctuation">.</span>read_tier <span class="token operator">==</span> kBlockCacheTier <span class="token comment">/* no_io */</span><span class="token punctuation">,</span>
                    <span class="token boolean">true</span> <span class="token comment">/* record_read_stats */</span><span class="token punctuation">,</span> file_read_hist<span class="token punctuation">,</span> skip_filters<span class="token punctuation">,</span>
                    level<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* prefetch_index_and_filter_in_cache */</span><span class="token punctuation">,</span>
                    max_file_size_for_l0_meta_pin<span class="token punctuation">,</span> file_meta<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        t <span class="token operator">=</span> <span class="token function">GetTableReaderFromHandle</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span>row_cache_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nullptr if no cache.</span>
      s <span class="token operator">=</span> t<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> k<span class="token punctuation">,</span> get_context<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip_filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
      get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Put the replay log in row cache only if something was found.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> row_cache_entry <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>row_cache_entry<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    size_t charge <span class="token operator">=</span> row_cache_entry<span class="token operator">-></span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span><span class="token operator">*</span> row_ptr <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>row_cache_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// If row cache is full, it's OK to continue.</span>
    ioptions_<span class="token punctuation">.</span>row_cache
        <span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>row_cache_key<span class="token punctuation">.</span><span class="token function">GetUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> row_ptr<span class="token punctuation">,</span> charge<span class="token punctuation">,</span>
                 <span class="token operator">&amp;</span>DeleteEntry<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">PermitUncheckedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先，它会判断 row_cache 是否打开，如果打开，则会在 row_cache 中进行一次查找，并把查找结果记录在 get_context 中。在进入 row_cache 前，会先将 key 包装成 row_cache 中形式的 key。通过下面的代码我们可以看到 row_cache 的 key 就是 fd_number+seq_no+user_key。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token class-name">TableCache</span><span class="token double-colon punctuation">::</span><span class="token function">CreateRowCacheKeyPrefix</span><span class="token punctuation">(</span><span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> options<span class="token punctuation">,</span>
                                         <span class="token keyword">const</span> FileDescriptor<span class="token operator">&amp;</span> fd<span class="token punctuation">,</span>
                                         <span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> internal_key<span class="token punctuation">,</span>
                                         GetContext<span class="token operator">*</span> get_context<span class="token punctuation">,</span>
                                         IterKey<span class="token operator">&amp;</span> row_cache_key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  <span class="token comment">// Compute row cache key.</span>
  row_cache_key<span class="token punctuation">.</span><span class="token function">TrimAppend</span><span class="token punctuation">(</span>row_cache_key<span class="token punctuation">.</span><span class="token function">Size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> row_cache_id_<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           row_cache_id_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AppendVarint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>row_cache_key<span class="token punctuation">,</span> fd_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">AppendVarint64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>row_cache_key<span class="token punctuation">,</span> seq_no<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">bool</span> <span class="token class-name">TableCache</span><span class="token double-colon punctuation">::</span><span class="token function">GetFromRowCache</span><span class="token punctuation">(</span><span class="token keyword">const</span> Slice<span class="token operator">&amp;</span> user_key<span class="token punctuation">,</span> IterKey<span class="token operator">&amp;</span> row_cache_key<span class="token punctuation">,</span>
                                 size_t prefix_size<span class="token punctuation">,</span> GetContext<span class="token operator">*</span> get_context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// ...</span>
  row_cache_key<span class="token punctuation">.</span><span class="token function">TrimAppend</span><span class="token punctuation">(</span>prefix_size<span class="token punctuation">,</span> user_key<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user_key<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>GetFromRowCache() 的具体实现我们先不分析。如果在 row_cache 中找到，那么 done 就是 true，后面的查找就全部跳过。如果没有找到，那么就会进入 sstable 中查找。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">TableReader<span class="token operator">*</span> t <span class="token operator">=</span> fd<span class="token punctuation">.</span>table_reader<span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span>row_cache_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nullptr if no cache.</span>
    s <span class="token operator">=</span> t<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> k<span class="token punctuation">,</span> get_context<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip_filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在分析函数之前，我们先分析一下 sstable 的结构，一个 sstable 对应一个 FileMetaData，类的主要成员如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">struct</span> <span class="token class-name">FileMetaData</span> <span class="token punctuation">&#123;</span>
  FileDescriptor fd<span class="token punctuation">;</span>
  InternalKey smallest<span class="token punctuation">;</span>            <span class="token comment">// Smallest internal key served by table</span>
  InternalKey largest<span class="token punctuation">;</span>             <span class="token comment">// Largest internal key served by table</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>其中，smallest 和 largest 就是 sstable 的两个边界 key。主要来看一下成员 fd：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// A copyable structure contains information needed to read data from an SST</span>
<span class="token comment">// file. It can contain a pointer to a table reader opened for the file, or</span>
<span class="token comment">// file number and size, which can be used to create a new table reader for it.</span>
<span class="token comment">// The behavior is undefined when a copied of the structure is used when the</span>
<span class="token comment">// file is not in any live version any more.</span>
<span class="token keyword">struct</span> <span class="token class-name">FileDescriptor</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Table reader in table_reader_handle</span>
  TableReader<span class="token operator">*</span> table_reader<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> packed_number_and_path_id<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> file_size<span class="token punctuation">;</span>  <span class="token comment">// File size in bytes</span>
  SequenceNumber smallest_seqno<span class="token punctuation">;</span>  <span class="token comment">// The smallest seqno in this file</span>
  SequenceNumber largest_seqno<span class="token punctuation">;</span>   <span class="token comment">// The largest seqno in this file</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如注释所述，该结构记录了 sstable 的信息，比如大小、seq 范围等等。但最重要的就是 TableReader，它才是 sstable 的核心数据结构，所有的读取均在其中进行。官方解释如下：</p>
<blockquote>
<p>A Table (also referred to as SST) is a sorted map from strings to strings. Tables are immutable and persistent.  A Table may be safely accessed from multiple threads without external synchronization. Table readers are used for reading various types of table formats supported by rocksdb including BlockBasedTable, PlainTable and CuckooTable format.</p>
</blockquote>
<p>也即，TableReader 实际上是一个抽象类，RocksDB 有多个不同的 sstable 实现，每一个 TableReader 的派生类都是一种实现，包括 BlockBasedTable、CuckooTable、MockTable、PlainTable 这四种。</p>
<p><img src="https://s1.ax1x.com/2022/10/24/x27w8I.png" alt="TableReader派生类"></p>
<p>RocksDB 默认采用的数据结构为 BlockBasedTable，这也是大部分资料都在讨论的基于 block 的 sstable，那我们就只关注它，其余实现都不看。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token comment">// Create default block based table factory.</span>
<span class="token keyword">extern</span> TableFactory<span class="token operator">*</span> <span class="token function">NewBlockBasedTableFactory</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> BlockBasedTableOptions<span class="token operator">&amp;</span> table_options <span class="token operator">=</span> <span class="token function">BlockBasedTableOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>这个结构的实现这里就不讨论了。针对该结构我曾做过一篇简要博客：<a target="_blank" rel="noopener" href="https://yesiyuan.cn/sstable-jie-shao/">sstable 简要分析</a>，不过那一篇没有进入源码层面，后面我会另出一篇对 sstable 源码进行详细分析：<a href="xxxx">sstable实现—BlockBasedTable （待填坑</a></p>
<p>在 row_cahce 中读取失败后，会拿到 sstable 的 TableReader，如果为空，那么就会在 table_cache 中找。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">TableReader<span class="token operator">*</span> t <span class="token operator">=</span> fd<span class="token punctuation">.</span>table_reader<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    s <span class="token operator">=</span> <span class="token function">FindTable</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> file_options_<span class="token punctuation">,</span> internal_comparator<span class="token punctuation">,</span> file_meta<span class="token punctuation">,</span>
                  <span class="token operator">&amp;</span>handle<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">,</span>
                  options<span class="token punctuation">.</span>read_tier <span class="token operator">==</span> kBlockCacheTier <span class="token comment">/* no_io */</span><span class="token punctuation">,</span>
                  <span class="token boolean">true</span> <span class="token comment">/* record_read_stats */</span><span class="token punctuation">,</span> file_read_hist<span class="token punctuation">,</span> skip_filters<span class="token punctuation">,</span>
                  level<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* prefetch_index_and_filter_in_cache */</span><span class="token punctuation">,</span>
                  max_file_size_for_l0_meta_pin<span class="token punctuation">,</span> file_meta<span class="token punctuation">.</span>temperature<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>TableCache::FindTable 的主要源码如下：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Status <span class="token class-name">TableCache</span><span class="token double-colon punctuation">::</span><span class="token function">FindTable</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> ro<span class="token punctuation">,</span> <span class="token keyword">const</span> FileOptions<span class="token operator">&amp;</span> file_options<span class="token punctuation">,</span>
    <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> internal_comparator<span class="token punctuation">,</span>
    <span class="token keyword">const</span> FileMetaData<span class="token operator">&amp;</span> file_meta<span class="token punctuation">,</span> Cache<span class="token double-colon punctuation">::</span>Handle<span class="token operator">*</span><span class="token operator">*</span> handle<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SliceTransform<span class="token operator">></span><span class="token operator">&amp;</span> prefix_extractor<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> no_io<span class="token punctuation">,</span> <span class="token keyword">bool</span> record_read_stats<span class="token punctuation">,</span> HistogramImpl<span class="token operator">*</span> file_read_hist<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> skip_filters<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">bool</span> prefetch_index_and_filter_in_cache<span class="token punctuation">,</span>
    size_t max_file_size_for_l0_meta_pin<span class="token punctuation">,</span> Temperature file_temperature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
    <span class="token comment">// ...</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TableReader<span class="token operator">></span> table_reader<span class="token punctuation">;</span>
    Status s <span class="token operator">=</span>
        <span class="token function">GetTableReader</span><span class="token punctuation">(</span>ro<span class="token punctuation">,</span> file_options<span class="token punctuation">,</span> internal_comparator<span class="token punctuation">,</span> file_meta<span class="token punctuation">,</span>
                       <span class="token boolean">false</span> <span class="token comment">/* sequential mode */</span><span class="token punctuation">,</span> record_read_stats<span class="token punctuation">,</span>
                       file_read_hist<span class="token punctuation">,</span> <span class="token operator">&amp;</span>table_reader<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">,</span>
                       skip_filters<span class="token punctuation">,</span> level<span class="token punctuation">,</span> prefetch_index_and_filter_in_cache<span class="token punctuation">,</span>
                       max_file_size_for_l0_meta_pin<span class="token punctuation">,</span> file_temperature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>table_reader <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">RecordTick</span><span class="token punctuation">(</span>ioptions_<span class="token punctuation">.</span>stats<span class="token punctuation">,</span> NO_FILE_ERRORS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// We do not cache error results so that if the error is transient,</span>
      <span class="token comment">// or somebody repairs the file, we recover automatically.</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      s <span class="token operator">=</span> cache_<span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> table_reader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>DeleteEntry<span class="token operator">&lt;</span>TableReader<span class="token operator">></span><span class="token punctuation">,</span>
                         handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// Release ownership of table reader.</span>
        table_reader<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>逻辑很简单，就是一般的 cache 逻辑，读取然后判断是否存在，不存在则创建一个插入 cache。上面的函数会调用 TableCache::GetTableReader()，我们来简单看下这个函数：</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp">Status <span class="token class-name">TableCache</span><span class="token double-colon punctuation">::</span><span class="token function">GetTableReader</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> ReadOptions<span class="token operator">&amp;</span> ro<span class="token punctuation">,</span> <span class="token keyword">const</span> FileOptions<span class="token operator">&amp;</span> file_options<span class="token punctuation">,</span>
    <span class="token keyword">const</span> InternalKeyComparator<span class="token operator">&amp;</span> internal_comparator<span class="token punctuation">,</span>
    <span class="token keyword">const</span> FileMetaData<span class="token operator">&amp;</span> file_meta<span class="token punctuation">,</span> <span class="token keyword">bool</span> sequential_mode<span class="token punctuation">,</span> <span class="token keyword">bool</span> record_read_stats<span class="token punctuation">,</span>
    HistogramImpl<span class="token operator">*</span> file_read_hist<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>TableReader<span class="token operator">></span><span class="token operator">*</span> table_reader<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> SliceTransform<span class="token operator">></span><span class="token operator">&amp;</span> prefix_extractor<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> skip_filters<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">bool</span> prefetch_index_and_filter_in_cache<span class="token punctuation">,</span>
    size_t max_file_size_for_l0_meta_pin<span class="token punctuation">,</span> Temperature file_temperature<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ...</span>
    s <span class="token operator">=</span> ioptions_<span class="token punctuation">.</span>table_factory<span class="token operator">-></span><span class="token function">NewTableReader</span><span class="token punctuation">(</span>
        ro<span class="token punctuation">,</span>
        <span class="token function">TableReaderOptions</span><span class="token punctuation">(</span>ioptions_<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">,</span> file_options<span class="token punctuation">,</span>
                           internal_comparator<span class="token punctuation">,</span> skip_filters<span class="token punctuation">,</span> immortal_tables_<span class="token punctuation">,</span>
                           <span class="token boolean">false</span> <span class="token comment">/* force_direct_prefetch */</span><span class="token punctuation">,</span> level<span class="token punctuation">,</span>
                           block_cache_tracer_<span class="token punctuation">,</span> max_file_size_for_l0_meta_pin<span class="token punctuation">,</span>
                           db_session_id_<span class="token punctuation">,</span> file_meta<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">GetNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                           expected_unique_id<span class="token punctuation">,</span> file_meta<span class="token punctuation">.</span>fd<span class="token punctuation">.</span>largest_seqno<span class="token punctuation">)</span><span class="token punctuation">,</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>file_reader<span class="token punctuation">)</span><span class="token punctuation">,</span> file_meta<span class="token punctuation">.</span>fd<span class="token punctuation">.</span><span class="token function">GetFileSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> table_reader<span class="token punctuation">,</span>
        prefetch_index_and_filter_in_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>即，通过相关的参数创建了一个 TableReader。该函数的具体实现先不深入分析，重新回到 TableCache::Get() 中。当获取到 TableReader 中后，RocksDB 就要在其中查找目标 key 了。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span>row_cache_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// nullptr if no cache.</span>
  s <span class="token operator">=</span> t<span class="token operator">-></span><span class="token function">Get</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> k<span class="token punctuation">,</span> get_context<span class="token punctuation">,</span> prefix_extractor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip_filters<span class="token punctuation">)</span><span class="token punctuation">;</span>
  get_context<span class="token operator">-></span><span class="token function">SetReplayLog</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>read_tier <span class="token operator">==</span> kBlockCacheTier <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">IsIncomplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// Couldn't find Table in cache but treat as kFound if no_io set</span>
  get_context<span class="token operator">-></span><span class="token function">MarkKeyMayExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token double-colon punctuation">::</span><span class="token function">OK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  done <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>查找的入口就是 TableReader::Get()，其也是一个抽象，不同的 sstable 数据结构对其的实现方式均不一样。</p>
<p><img src="https://s1.ax1x.com/2022/10/24/x2bju6.png" alt="TableReader::Get()"></p>
<p>当然，默认的就是 BlockBasedTable::Get()，这里我们就不深入了，放在对 sstable 单独分析的那篇博客中讲：<a href="xxxx">sstable实现—BlockBasedTable （待填坑</a></p>
<p>当从 sstable 中找到后，将会把 &lt;key, value&gt; 缓存进 row_cache 中。</p>
<pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>done <span class="token operator">&amp;&amp;</span> s<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> row_cache_entry <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>row_cache_entry<span class="token operator">-></span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  size_t charge <span class="token operator">=</span> row_cache_entry<span class="token operator">-></span><span class="token function">capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">void</span><span class="token operator">*</span> row_ptr <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token operator">*</span>row_cache_entry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// If row cache is full, it's OK to continue.</span>
  ioptions_<span class="token punctuation">.</span>row_cache
      <span class="token operator">-></span><span class="token function">Insert</span><span class="token punctuation">(</span>row_cache_key<span class="token punctuation">.</span><span class="token function">GetUserKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> row_ptr<span class="token punctuation">,</span> charge<span class="token punctuation">,</span>
               <span class="token operator">&amp;</span>DeleteEntry<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">></span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">PermitUncheckedError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<p>至此，从 sstable 中的读流程分析完毕，意味着 RocksDB 的整个读流程分析完毕。虽然忽略了一些重要实现，但它们会在后续对数据结构的专讲中详细说明。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">SrcMiLe</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://example.com/rocksdb-yuan-ma-xue-xi-si-du-san/">http://example.com/rocksdb-yuan-ma-xue-xi-si-du-san/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">SrcMiLe</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/%E5%AD%98%E5%82%A8/">
                                    <span class="chip bg-color">存储</span>
                                </a>
                            
                                <a href="/tags/rocksdb/">
                                    <span class="chip bg-color">rocksdb</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.jpg" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table,
    th,
    td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table,
    th,
    td {
        border: 0;
    }

    table tr:nth-child(2n),
    thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked),
    [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table,
    th,
    td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n),
    thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked),
    [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling"
        style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: '3sjvW0J6zav7ITbeaCaE5CCA-gzGzoHsz',
        appKey: 'M81tKeUfrGJmrEv4VDvcyEAH',
        notify: 'false' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: 'monsterid',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

<!--酷Q推送-->

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/rocksdb-yuan-ma-xue-xi-wu-xie-yi-kuang-jia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/15.jpg" class="responsive-img" alt="RocksDB源码学习(五): 写(一)-框架">
                        
                        <span class="card-title">RocksDB源码学习(五): 写(一)-框架</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-10-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%98%E5%82%A8/" class="post-category">
                                    存储
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%98%E5%82%A8/">
                        <span class="chip bg-color">存储</span>
                    </a>
                    
                    <a href="/tags/rocksdb/">
                        <span class="chip bg-color">rocksdb</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/rocksdb-yuan-ma-xue-xi-san-du-er/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="RocksDB源码学习(三): 读(二)">
                        
                        <span class="card-title">RocksDB源码学习(三): 读(二)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-10-21
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%AD%98%E5%82%A8/" class="post-category">
                                    存储
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E5%AD%98%E5%82%A8/">
                        <span class="chip bg-color">存储</span>
                    </a>
                    
                    <a href="/tags/rocksdb/">
                        <span class="chip bg-color">rocksdb</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




                            <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2022-2023</span>
            
            <span id="year">2022</span>
            <a href="/about" target="_blank">SrcMiLe</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2022";
                    var startMonth = "1";
                    var startDate = "12";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/sakura-ysy" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2575633193@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2575633193" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2575633193" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


                                <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

                                    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


                                        <script
                                            src="/libs/materialize/materialize.min.js"></script>
                                        <script
                                            src="/libs/masonry/masonry.pkgd.min.js"></script>
                                        <script
                                            src="/libs/aos/aos.js"></script>
                                        <script
                                            src="/libs/scrollprogress/scrollProgress.min.js"></script>
                                        <script
                                            src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
                                        <script
                                            src="/js/matery.js"></script>

                                        <!-- Baidu Analytics -->

                                            <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

                                                
                                                        
                                                            <script async
                                                                src="/libs/others/busuanzi.pure.mini.js"></script>
                                                            

                                                                

                                                                        

                                                                                
                                                                                        

                                                                                                
                                                                                                    
                                                                                                        <script
                                                                                                            type="text/javascript"
                                                                                                            size="150"
                                                                                                            alpha='0.6'
                                                                                                            zIndex="-1"
                                                                                                            src="/libs/background/ribbon-refresh.min.js"
                                                                                                            async="async"></script>
                                                                                                        

                                                                                                            

                                                                                                                    
                                                                                                                        <script
                                                                                                                            src="/libs/instantpage/instantpage.js"
                                                                                                                            type="module"></script>
                                                                                                                        

                </body>

</html>

<!-- 樱花 -->
<script type="text/javascript" src="/js/sakura.js"></script>